/*! SpriteGame - v0.1.0 - 2015-08-26
* https://github.com/MRH4287/JSCanvasGame
* Copyright (c) 2015 Manuel Holzhauser; Licensed MIT */
var PlayerState;!function(a){a[a.Standing=0]="Standing",a[a.Walking=1]="Walking"}(PlayerState||(PlayerState={}));var WalkDirection;!function(a){a[a.Up=0]="Up",a[a.Down=1]="Down",a[a.Left=2]="Left",a[a.Right=3]="Right",a[a.None=4]="None"}(WalkDirection||(WalkDirection={}));var CoordinateHelper=function(){function a(){}return a.Add=function(a,b){var c={X:a.X+b.X,Y:a.Y+b.Y};return c},a.AddX=function(a,b){return this.Add(a,{X:b,Y:0})},a.AddY=function(a,b){return this.Add(a,{X:0,Y:b})},a.Subtract=function(a,b){var c={X:a.X-b.X,Y:a.Y-b.Y};return c},a.Length=function(a){return Math.sqrt(Math.pow(a.X,2)+Math.pow(a.Y,2))},a.Normalize=function(a){var b=this.Length(a);return 0===b?a:{X:a.X/b,Y:a.Y/b}},a.Multiply=function(a,b){return{X:a.X*b,Y:a.Y*b}},a}(),GameHandler=function(){function a(a){this.config={debug:!0,width:800,height:300,tileSize:25,elementsPath:"data/elements.json",npcDataPath:"data/npc/npcData.json",mapPath:"data/map2.json",showBlocking:!0,verbose:!1,initStaticAnimations:!0,playStaticAnimations:!0,hideOwnUsername:!0,playerModel:"pichu",basePath:""},this.elements={},this.npcDefinitions={},this.animations={},this.tileIDIndex={},this.tileFlagIndex={},this.elementsFlagIndex={},this.config=$.extend(this.config,a)}return a.prototype.init=function(a){var b=this;this.eventHandler.callEvent("preInit",this,null),this.loadConfig(function(){b.initAnimations(function(){b.windowManager=new WindowManager(b),b.eventHandler.callEvent("TaskCreated",self,"Player - INIT"),window.setTimeout(function(){b.loadMap(function(){b.eventHandler.callEvent("postInit",b,null),b.eventHandler.callEvent("TaskDisposed",self,"Player - INIT"),a()})},100)})})},a.prototype.initAnimationContainer=function(){this.bottomAnimationHandler=this.createAnimationHandler(0,this.renderer.getBottomAnimationLayer()),this.middleAnimationHandler=this.createAnimationHandler(1,this.renderer.getMiddleAnimationLayer()),this.topAnimationHandler=this.createAnimationHandler(2,this.renderer.getTopAnimationLayer()),this.playerAnimationHandler=this.createAnimationHandler(3,this.renderer.getPlayerLayer()),this.playerManager=new PlayerManager(this,this.playerAnimationHandler,this.config.playerModel),this.npcManager=new NPCHandler(this,this.middleAnimationHandler),this.pathHandler=new PathHandler(this)},a.prototype.createAnimationHandler=function(a,b,c){var d=new AnimationHandler(this,a,c);return d.setLayer(b),d},a.prototype.setRenderer=function(a){this.renderer=a},a.prototype.setEventHandler=function(a){this.eventHandler=a},a.prototype.initAnimations=function(a){this.spriteContainer={};var b=this,c=[];$.each(b.elements,function(a,b){c.push(b)});var d=function(){var e=c.pop();return void 0===e||null===e?void a():void 0!==e.Dynamic&&e.Dynamic===!0&&void 0!==e.AnimationDefinition&&""!==e.AnimationDefinition?void b.loadAnimation(e.AnimationDefinition,function(){d()}):void d()};d()},a.prototype.loadAnimation=function(a,b){var c=this;this.getFile(a,function(a){for(var d={ID:a.ID,ImageURI:a.ImageURI,Animations:{}},e=0;e<a.Animations.length;e++){var f=a.Animations[e];d.Animations[f.ID]=f}c.animations[a.ID]=d,c.preloadImage(a.ID,a.ImageURI),b()})},a.prototype.preloadImage=function(a,b){var c=this;this.loadImage(b,function(b){c.log("Preload of Image '"+a+"' done: ",b),c.spriteContainer[a]=b})},a.prototype.loadImage=function(a,b){var c=new Image;c.onload=function(){b(c)},c.src=this.config.basePath+a},a.prototype.loadConfig=function(a){var b=this;this.eventHandler.callEvent("preConfigLoad",this,null),this.log("Load Config from path: ",this.config.elementsPath),this.getFile(this.config.elementsPath,function(c){var d=b;$.each(c,function(a,b){d.elements[b.ID]=b,void 0!==d.elements[b.ID].Flags&&$.each(d.elements[b.ID].Flags,function(a,c){void 0===d.elementsFlagIndex[c]&&(d.elementsFlagIndex[c]=[]),d.elementsFlagIndex[c].push(b)})}),b.log("Element Definitions loaded: ",b.elements),b.log("Load NPC-Data"),b.getFile(b.config.npcDataPath,function(c){$.each(c,function(a,b){d.npcDefinitions[b.ID]=b}),b.log("NPC-Data loaded",b.npcDefinitions),void 0!==b.renderer&&(console.log(b.renderer),b.renderer.setConfig(b.elements)),b.eventHandler.callEvent("postConfigLoad",b,null),a()})})},a.prototype.changeLevel=function(a){var b=this;this.eventHandler.callEvent("preLevelChange",this,a),this.config.mapPath=a,this.map=void 0,this.tileIDIndex={},this.tileFlagIndex={},this.elementsFlagIndex={},this.npcManager.clear(),this.loadMap(function(){b.playerManager.movePlayerToSpawn(),b.playerManager.resetPlayerModel(),b.eventHandler.callEvent("postLevelChange",b,null)},!0)},a.prototype.loadMap=function(a,b){var c=this;"undefined"==typeof b&&(b=!1),this.eventHandler.callEvent("preMapLoad",this,null),this.log("Load Map from path:",this.config.mapPath),this.getFile(this.config.mapPath,function(d){var e=3025,f=0;if($.each(d,function(a,b){f+=b.length}),console.log("TileCount: "+f+" - Max: "+e),f>e)return console.error("The Size of the Map is too big!"),void a();if(void 0!==c.renderer&&c.renderer.initMap(d[0].length,d.length),b){var g=[c.bottomAnimationHandler,c.middleAnimationHandler,c.middleAnimationHandler,c.playerAnimationHandler];$.each(g,function(a,b){void 0!==b&&b.clear()})}else c.initAnimationContainer();for(var h=[],i=0;i<d.length;i++)for(var j=d[i],k=0;k<j.length;k++)h.push({element:d[i][k],x:k,y:i});var l=function(d){c.map=d,void 0!==c.renderer&&c.renderer.setMap(c.map,b),c.log("Map Loaded: ",c.map),c.eventHandler.callEvent("postMapLoad",c,c.map),a()},m=function(){var a=h.pop();return void 0===a||null===a?void l(d):void c.updateTile(a.element,a.x+1,a.y+1,function(){m()})};m()})},a.prototype.updateTile=function(a,b,c,d){var e=this;a.XCoord=b,a.YCoord=c,this.eventHandler.callEvent("preTileUpdate",this,a),void 0!==a.BottomElementID&&null!==a.BottomElementID&&""!==a.BottomElementID&&(void 0!==this.elements[a.BottomElementID]?a.BottomElement=this.elements[a.BottomElementID]:this.warn("Warning: No Element definintion '"+a.BottomElementID+"' for Tile: ",a)),void 0!==a.MiddleElementID&&null!==a.MiddleElementID&&""!==a.MiddleElementID&&(void 0!==this.elements[a.MiddleElementID]?a.MiddleElement=this.elements[a.MiddleElementID]:this.warn("Warning: No Element definintion '"+a.MiddleElementID+"' for Tile: ",a)),void 0!==a.TopElementID&&null!==a.TopElementID&&""!==a.TopElementID&&(void 0!==this.elements[a.TopElementID]?a.TopElement=this.elements[a.TopElementID]:this.warn("Warning: No Element definintion '"+a.TopElementID+"' for Tile: ",a)),void 0!==a.ID&&(this.tileIDIndex[a.ID]=a);var f=this;void 0!==a.Flags&&$.each(a.Flags,function(b,c){void 0===f.tileFlagIndex[c]&&(f.tileFlagIndex[c]=[]),f.tileFlagIndex[c].push(a)});var g=function(){e.eventHandler.callEvent("postTileUpdate",e,a),d(a)};if("NPCSpawn"!==a.MiddleElementID)return void g();var h=new RegExp("NPC=(.+)"),i=new RegExp("NPCName=(.+)"),j=null,k=null;if($.each(a.Flags,function(a,b){if(h.test(b)){var c=h.exec(b);j=c[1]}if(i.test(b)){var d=h.exec(b);k=d[1]}}),null!==j){var l=this.npcDefinitions[j];k=k||j+Math.random(),console.info("Add NPC with ID: ",k);var m=function(){e.npcManager.addNPC(k,{X:a.XCoord,Y:a.YCoord},l.AnimationContainer,l.DefaultAnimation,l.Speed),g()};return void 0===this.animations[l.AnimationContainer]?(this.log("Animation for NPC not available. Load Animation: ",l.AnimationContainer),void this.loadAnimation("data/animations/"+l.AnimationContainer+".json",function(){m()})):void m()}this.warn("Element has Element 'NPCSpawn' but don't define the Flag 'NPC=...'!",a)},a.prototype.getTileAtPos=function(a,b){return this.map[b-1][a-1]},a.prototype.isCoordPassable=function(a,b){var c=this.getTileAtPos(a,b);if(void 0===c)return this.warn("Tile not found: ",[a,b]),!1;var d=void 0!==c.BottomElement&&null!==c.BottomElement?c.BottomElement.Passable:!0,e=void 0!==c.MiddleElement&&null!==c.MiddleElement?c.MiddleElement.Passable:!0,f=void 0!==c.TopElement&&null!==c.TopElement?c.TopElement.Passable:!0,g={Tile:c,X:a,Y:b,result:d&&e&&f};return this.eventHandler.callEvent("CheckIsPassable",this,g),g.result},a.prototype.getMapPassableData=function(){for(var a=this.map.length,b=this.map[0].length,c=[],d=0;a>d;d++){for(var e=[],f=0;b>f;f++)e[f]=this.isCoordPassable(d+1,f+1)?1:0;c[d]=e}return c},a.prototype.getElementByID=function(a){return this.elements[a]},a.prototype.getElementsByFlagName=function(a){var b=this.elementsFlagIndex[a];return void 0!==b?b:[]},a.prototype.getTileByID=function(a){return this.tileIDIndex[a]},a.prototype.getTilesByFlagName=function(a){var b=this.tileFlagIndex[a];return void 0!==b?b:[]},a.prototype.execVerbose=function(a){this.config.verbose=!0,a(),this.config.verbose=!1},a.prototype.activateVerbose=function(a){"undefined"==typeof a&&(a=500),this.config.verbose=!0;var b=this;window.setTimeout(function(){b.config.verbose=!1},a)},a.prototype.getFile=function(a,b,c){var d=!("undefined"==typeof b);c="undefined"==typeof c?"json":c;var e=null;return $.ajax({dataType:c,url:this.config.basePath+a,success:function(a){d?b(a):e=a},async:d}),e},a.prototype.log=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];this.config.debug&&console.log(a,b)},a.prototype.info=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];this.config.debug&&console.info(a,b)},a.prototype.warn=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];this.config.debug&&console.warn(a,b)},a.prototype.error=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];this.config.debug&&console.error(a,b)},a}(),AnimationHandler=function(){function a(a,b,c){this.playableAnimations={},this.animationGroups={},this.useAnimationGroups=!0,this.staticName=null,this.genericDrawActions={},void 0!==c&&(this.useAnimationGroups=!1,this.staticName=c),this.eventHandler=a.eventHandler,this.renderer=a.renderer,this.gameHandler=a,this.layer=b;var d=this;this.eventHandler.addEventListener("render",function(){d.gameHandler.config.playStaticAnimations&&d.renderAnimations(d),$.each(d.genericDrawActions,function(a,b){d.gameHandler.config.verbose&&d.gameHandler.log("Draw Generic Action: ",b,d),b.Action()})}),this.eventHandler.addEventListener("postTileUpdate",function(a,b){d.gameHandler.config.initStaticAnimations&&d.tileUpdate(b)})}return a.prototype.setLayer=function(a){this.canvas=a.canvas,this.ctx=a.ctx;var b=$(this.canvas);this.width=b.width(),this.height=b.height()},a.prototype.clear=function(){var a=this;$.each(this.playableAnimations,function(b,c){a.stopAnimation(c.ID)}),this.playableAnimations={},this.animationGroups={},this.genericDrawActions={}},a.prototype.setPosition=function(a,b,c,d){"undefined"==typeof d&&(d=!0),void 0!==this.playableAnimations[a]&&(this.playableAnimations[a].X=b,this.playableAnimations[a].Y=c,d&&this.eventHandler.callEvent("forceRerender",this,null))},a.prototype.tileUpdate=function(a){var b=!1,c=null,d=null;if(void 0!==a.BottomElement&&void 0!==a.BottomElement.Dynamic&&a.BottomElement.Dynamic===!0&&(b=!0,c=a.BottomElement,d=0),void 0!==a.MiddleElement&&void 0!==a.MiddleElement.Dynamic&&a.MiddleElement.Dynamic===!0&&(b?(this.gameHandler.warn("Only one Animation per Tile possible!",a.MiddleElement.AnimationContainer),this.gameHandler.info("Alread set: ",c.AnimationContainer)):(b=!0,c=a.MiddleElement,d=1)),void 0!==a.TopElement&&void 0!==a.TopElement.Dynamic&&a.TopElement.Dynamic===!0&&(b?(this.gameHandler.warn("Only one Animation per Tile possible!",a.TopElement.AnimationContainer),this.gameHandler.info("Alread set: ",c.AnimationContainer)):(b=!0,c=a.TopElement,d=2)),b)if(c.Level===this.layer){this.gameHandler.config.verbose&&this.gameHandler.log("Load Animation for item: ",a);var e=void 0===a.ID||null===a.ID||""===a.ID?"ent-"+c.ID+"-"+Math.random()+"-"+Math.random():"ent-"+a.ID;a.Animation=this.addAnimation(e,c.AnimationContainer,c.DefaultAnimation,a.XCoord,a.YCoord)}else this.gameHandler.config.verbose&&this.gameHandler.log("Ignore Dynamic Element .. not in the same layer ...")},a.prototype.addAnimation=function(a,b,c,d,e){var f=this.gameHandler.animations[b];if(void 0===f)return void this.gameHandler.warn("Unknown Animation Cotainer: ",b,this.gameHandler.animations);var g=f.Animations[c];this.useAnimationGroups?void 0===g.AnimationGroup||null===g.AnimationGroup||""===g.AnimationGroup?g.AnimationGroup="group-"+a:"@"===g.AnimationGroup&&(g.AnimationGroup="group-"+Math.random()+Math.random()):g.AnimationGroup=this.staticName;var h={ID:a,AnimationContainer:f,X:d,Y:e,Animation:null,AnimationGroup:g.AnimationGroup};return this.playableAnimations[a]=h,this.playAnimation(a,c,g.AnimationGroup),h},a.prototype.drawColorRect=function(a,b,c,d,e,f,g,h,i,j){"undefined"==typeof i&&(i=1),"undefined"==typeof j&&(j=!0),this.drawRect(a,b,c,d,e,"rgba("+f+","+g+","+h+","+i+")",j)},a.prototype.writeText=function(a,b,c,d,e,f,g,h,i,j){"undefined"==typeof e&&(e="bold 12px sans-serif"),"undefined"==typeof f&&(f="top"),"undefined"==typeof g&&(g="left"),"undefined"==typeof h&&(h="rgba(0,0,0,1)"),"undefined"==typeof j&&(j=!0);var k=this;this.genericDrawActions[a]={Type:"Text",Action:function(){k.ctx.font=e,k.ctx.textBaseline=f,k.ctx.textAlign=g,k.ctx.fillStyle=h,void 0!==i?k.ctx.fillText(b,c,d,i):k.ctx.fillText(b,c,d)}},j&&this.eventHandler.callEvent("forceRerender",this,null)},a.prototype.drawRect=function(a,b,c,d,e,f,g){"undefined"==typeof f&&(f="rgba(225,225,225,1)"),"undefined"==typeof g&&(g=!0);var h=this;this.genericDrawActions[a]={Type:"Rectangle",Action:function(){h.ctx.fillStyle=f,h.ctx.fillRect(b,c,d,e)}},g&&this.eventHandler.callEvent("forceRerender",this,null)},a.prototype.removeGenericDraw=function(a){void 0!==this.genericDrawActions[a]&&(delete this.genericDrawActions[a],this.eventHandler.callEvent("forceRerender",this,null))},a.prototype.getNewAnimationInstance=function(a){return jQuery.extend({},a)},a.prototype.playAnimation=function(a,b,c){var d=this.playableAnimations[a];if(void 0===d&&console.error("Can't play Animation: No Animation Container with name '"+a+"' can be found!"),null===d.Animation||d.Animation.ID!==b){this.stopAnimation(a);var e=this.getNewAnimationInstance(d.AnimationContainer.Animations[b]);d.Animation=e,(void 0===c||null===c||""===c)&&(c=void 0===e.AnimationGroup||null===e.AnimationGroup||""===e.AnimationGroup?"group-"+Math.random():e.AnimationGroup);var f=this.useAnimationGroups?"anim-"+c:this.staticName;if(this.useAnimationGroups||(c=this.staticName),this.gameHandler.config.verbose&&this.gameHandler.log("Animation Group: ",c),e.ImageCount>0&&e.Speed>0){var g=this;void 0===this.animationGroups[c]&&(this.gameHandler.config.verbose&&this.gameHandler.log("Dynamic Animation. Start timer: ",f),this.animationGroups[c]={},this.eventHandler.addTimer(f,function(){if("undefined"==typeof g.animationGroups[c])return g.gameHandler.config.verbose&&g.gameHandler.log("Unknown Animation Group. Abort Render. ",c),void g.eventHandler.stopTimer(f);var a=[];$.each(g.animationGroups[c],function(b,c){a.push(g.playableAnimations[b])}),g.animationStep(c,a),g.eventHandler.callEvent("forceRerender",g,null)},e.Speed)),d.AnimationGroup=c,this.animationGroups[c][a]=!0}else d.AnimationGroup=null,this.gameHandler.config.verbose&&this.gameHandler.log("Satic Animation applied ....");this.eventHandler.callEvent("forceRerender",this,null)}},a.prototype.stopAnimation=function(a){if(this.useAnimationGroups){var b=this.playableAnimations[a];if(null==b.Animation)return;if(null!=b.AnimationGroup&&(delete this.animationGroups[b.AnimationGroup][b.ID],void 0!==this.animationGroups[b.AnimationGroup])){var c=0;if($.each(this.animationGroups[b.AnimationGroup],function(a,b){c++}),0===c){this.gameHandler.config.verbose&&this.gameHandler.log("Close Animation Group - Empty",f);var d="anim-"+f;this.eventHandler.stopTimer(d)}}b.AnimationGroup=null,b.Animation=null}else{var e=this.staticName,f=this.staticName;this.eventHandler.stopTimer(e);var g=this.playableAnimations[a];g.Animation=null,this.animationGroups[f]=void 0}},a.prototype.animationStep=function(a,b){if(null!==b){if(0===b.length){this.gameHandler.config.verbose&&this.gameHandler.log("Close Animation Group - AnimationStep is Empty",a);var c="anim-"+a;return void this.eventHandler.stopTimer(c)}var d=[];if($.each(b,function(a,b){d.push(b.Animation)}),0===d.length)return this.gameHandler.config.verbose&&this.gameHandler.log("Close Animation Group - AnimationStep is Empty",a),void this.eventHandler.stopTimer("anim-"+a);if(a!==b[0].AnimationGroup)return this.gameHandler.warn("Wrong Animation Group. Don't Update!",b),this.gameHandler.config.verbose&&this.gameHandler.log("Close Animation Group - Wrong Animation Group",a),void this.eventHandler.stopTimer("anim-"+a);var e=d[0].AnimationState;e+=d[0].IsReverse?-1:1,e>=d[0].ImageCount||0>e?d[0].Loop?d[0].ReverseOnEnd?d[0].IsReverse?($.each(d,function(a,b){b.AnimationState=0}),d[0].IsReverse=!1):($.each(d,function(a,b){b.AnimationState=d[0].ImageCount-1}),d[0].IsReverse=!0):d[0].IsReverse?$.each(d,function(a,b){b.AnimationState=d[0].ImageCount-1}):$.each(d,function(a,b){b.AnimationState=0}):$.each(d,function(a,b){this.stopAnimation(b.ID)}):$.each(d,function(a,b){b.AnimationState=e})}},a.prototype.getPosition=function(a,b){var c=this.renderer.getTileSize(),d={X:(a-1)*c,Y:(b-1)*c};return d},a.prototype.renderAnimations=function(a){return null==a.ctx?void a.gameHandler.warn("Animation: No render Context found!",a):(a.eventHandler.callEvent("animationsPreRender",a,null),a.renderer.clearRenderContext(a.ctx),$.each(a.playableAnimations,function(b,c){var d=a.getPosition(c.X,c.Y);a.renderAninmation(c.AnimationContainer,c.Animation,d.X,d.Y)}),void a.eventHandler.callEvent("animationsPostRender",a,null))},a.prototype.renderAninmation=function(a,b,c,d){if(null!=b){var e=a.ID,f=b.StartX+b.OffsetX*b.AnimationState,g=b.StartY+b.OffsetY*b.AnimationState,h=this.renderer.getTileSize(),i=b.DisplayWidth*h,j=b.DisplayHeight*h,k=c+b.DisplayOffsetX*h,l=d+b.DisplayOffsetY*h;this.drawImage(e,f,g,b.ImageWidth,b.ImageHeight,k,l,i,j)}},a.prototype.drawImage=function(a,b,c,d,e,f,g,h,i){return void 0===this.gameHandler.spriteContainer[a]?void(this.gameHandler.config.verbose&&console.warn("No sprite with name '"+a+"' was found!")):void this.ctx.drawImage(this.gameHandler.spriteContainer[a],b,c,d,e,f,g,h,i)},a.prototype.test=function(){var a=this;this.gameHandler.loadAnimation("data/animations/mew.json",function(){var b=a.gameHandler.playerManager.getPosition();a.addAnimation("test","mew","stand",b.X,b.Y+2)})},a}(),EventHandler=function(){function a(a){this.events={},this.calledEvents=[],this.gameHandler=null,this.timedEvents={},this.gameHandler=a,a.setEventHandler(this)}return a.prototype.addEventListener=function(a,b){void 0===this.events&&(this.events={}),void 0===this.events[a]&&(this.events[a]={callbacks:[]}),this.events[a].callbacks.push(b)},a.prototype.callEvent=function(a,b,c){this.addEventToList(a);var d=void 0===this.events||void 0===this.events[a];if(this.gameHandler.config.verbose&&console.log("Event Called: ",{name:a,sender:b,arguments:c,heared:!d}),d)return!1;for(var e=0;e<this.events[a].callbacks.length;e++)this.events[a].callbacks[e](b,c)},a.prototype.getEvents=function(){return Object.keys(this.events).concat(this.calledEvents)},a.prototype.containesKey=function(a){return-1!==this.getEvents().indexOf(a)},a.prototype.addTimer=function(a,b,c,d,e){void 0!==this.timedEvents[a]&&this.stopTimer(a),this.timedEvents[a]={run:!0,callback:b};var f=this,g=function(){try{var b=f.timedEvents[a];void 0!==b&&b.run?(b.callback(d,e),f.callEvent("TaskCreated",f,"Timer - "+a),window.setTimeout(g,c)):delete f.timedEvents[a]}catch(h){f.gameHandler.warn("Exception while executing timed Trigger '"+a+"': ",h),delete f.timedEvents[a]}f.callEvent("TaskDisposed",f,"Timer - "+a)};f.callEvent("TaskCreated",f,"Timer - "+a),window.setTimeout(g,c)},a.prototype.addTimedTrigger=function(a,b,c,d,e){var f=this,g=function(a,c){f.callEvent(b,a,c)};this.addTimer(a,g,c,d,e)},a.prototype.stopTimer=function(a){void 0!==this.timedEvents[a]&&(this.timedEvents[a].run=!1)},a.prototype.addEventToList=function(a){-1===this.calledEvents.indexOf(a)&&this.calledEvents.push(a)},a}(),MessageType;!function(a){a[a.PlayerJoined=0]="PlayerJoined",a[a.PlayerDisconnected=1]="PlayerDisconnected",a[a.ConnectionRequest=2]="ConnectionRequest",a[a.ConnectionResponse=3]="ConnectionResponse",a[a.PlayerBeginMove=4]="PlayerBeginMove",a[a.PlayerPositionChanged=5]="PlayerPositionChanged",a[a.PlayerAnimationChanged=6]="PlayerAnimationChanged",a[a.PlayerStopMove=7]="PlayerStopMove",a[a.PlayerKicked=8]="PlayerKicked",a[a.ChatMessage=9]="ChatMessage"}(MessageType||(MessageType={}));var MultiplayerHandler=function(){function a(a,b,c){this.id=void 0,this.username=void 0,this.usernameTable={},this.gameHandler=a,this.serverAdress=b,this.username=c;var d=this;this.gameHandler.eventHandler.addEventListener("PlayerPositionChanged",function(a,b){var c={Type:MessageType[5],ID:d.id,Position:b};d.send(c),d.gameHandler.config.hideOwnUsername||d.renderPlayerLabel(d.username,b)}),this.gameHandler.eventHandler.addEventListener("playerAnimationChange",function(a,b){var c={Type:MessageType[6],ID:d.id,Animation:b};d.send(c)}),this.gameHandler.eventHandler.addEventListener("PlayerStartMoving",function(a,b){var c={Type:MessageType[4],ID:d.id,Position:b.Position,Target:b.Target,Direction:b.Direction,Speed:b.Speed};d.send(c)}),this.gameHandler.eventHandler.addEventListener("PlayerStopMoving",function(a,b){var c={Type:MessageType[7],ID:d.id};d.send(c)})}return a.prototype.init=function(){},a.prototype.connect=function(){this.socket=new WebSocket(this.serverAdress);var a=this;this.socket.onopen=function(){var b={Type:"ConnectionRequest",Position:a.gameHandler.playerManager.getPosition(),AnimationContainer:a.gameHandler.config.playerModel,Animation:"stand",Username:a.username};a.send(b,!0)},this.socket.onmessage=function(b){var c=JSON.parse(b.data);if(void 0!==c&&null!==c&&"object"==typeof c)if(void 0!==c.Type)try{var d=MessageType[c.Type];if(null!==d)switch(d){case 0:a.gameHandler.npcManager.addNPC(c.ID,c.Position,c.AnimationContainer,c.Animation),a.usernameTable[c.ID]=c.Username,a.renderPlayerLabel(c.Username,c.Position);break;case 4:break;case 5:a.gameHandler.npcManager.setPosition(c.ID,c.Position),a.renderPlayerLabel(a.usernameTable[c.ID],c.Position);break;case 6:a.gameHandler.npcManager.setAnimation(c.ID,c.Animation);break;case 7:a.gameHandler.npcManager.NPCMotionStop(c.ID);break;case 3:a.id=c.ID,a.username=c.Username,a.gameHandler.config.hideOwnUsername||a.renderPlayerLabel(a.username,a.gameHandler.playerManager.getPosition());break;case 1:a.gameHandler.npcManager.removeNPC(c.ID),a.removePlayerLabel(a.usernameTable[c.ID]),delete a.usernameTable[c.ID];break;case 9:console.log("Chat - "+c.ID+": "+c.Message),a.gameHandler.npcManager.renderSpeechBubble(c.ID,c.Message);break;case 8:alert("You have been kicked from the Server! Reason: "+c.Reason),a.id=void 0}else a.gameHandler.error("Unknown Message Type on Socket: ",c.Type,c)}catch(e){a.gameHandler.error("Error parsing Socket Message: ",e,c)}else a.gameHandler.error("No Type Attribute on Socket Message:",c)}},a.prototype.sendChatMessage=function(a){this.gameHandler.playerManager.renderSpeechBubble(a);var b={ID:this.id,Message:a,Type:"ChatMessage"};this.send(b)},a.prototype.renderPlayerLabel=function(a,b){var c="PlayerNameTag-"+a,d=this.gameHandler.topAnimationHandler,e=5*a.length+15,f=11,g=5,h=0;e>this.gameHandler.config.tileSize&&(h=(e-this.gameHandler.config.tileSize)/2);var i={X:(b.X-1)*this.gameHandler.config.tileSize-h,Y:(b.Y-1.4)*this.gameHandler.config.tileSize};d.drawColorRect(c,i.X,i.Y,e,f,255,255,255,.3,!1),d.writeText(c+"-text",a,i.X+e/2,i.Y,"11px sans-serif","top","center","rgba(0,0,0,1)",e-2*g,!1)},a.prototype.removePlayerLabel=function(a){var b="PlayerNameTag-"+a,c=this.gameHandler.topAnimationHandler;c.removeGenericDraw(b),c.removeGenericDraw(b+"-text")},a.prototype.send=function(a,b){if("undefined"==typeof b&&(b=!1),b||void 0!==this.id){var c=JSON.stringify(a);this.socket.send(c)}},a}(),NPCHandler=function(){function a(a,b){this.npcList={},this.updatesPerSecond=10,this.gameHandler=a,this.animation=b;var c=this;this.gameHandler.eventHandler.addEventListener("CheckIsPassable",function(a,b){$.each(c.npcList,function(a,c){c.Position.X===b.X&&c.Position.Y===b.Y&&(b.result=!1)})}),this.gameHandler.eventHandler.addEventListener("PlayerAction",function(a,b){$.each(c.npcList,function(a,d){d.Position.X===b.X&&d.Position.Y===b.Y&&c.gameHandler.eventHandler.callEvent("PlayerNPCAction",c,{name:a,data:d,animationData:c.animation.playableAnimations[d.GUID],X:b.X,Y:b.Y})})}),this.gameHandler.eventHandler.addTimedTrigger("NPCSpeechBubbleCheck","NPCSpeechBubbleCheck",1e3,this,null),this.gameHandler.eventHandler.addEventListener("NPCSpeechBubbleCheck",function(){$.each(c.npcList,function(a,b){void 0!==b.DisplaySpeechBubbleTo&&b.DisplaySpeechBubbleTo<Date.now()&&(c.removeSpeechBubble(a),b.DisplaySpeechBubbleTo=void 0)})}),c.gameHandler.eventHandler.callEvent("TaskCreated",c,"NPC - Constructor"),window.setTimeout(function(){c.gameHandler.eventHandler.callEvent("npcInit",c,null),c.gameHandler.eventHandler.callEvent("TaskDisposed",c,"NPC - Constructor")},100)}return a.prototype.clear=function(){var a=this;$.each(this.npcList,function(b,c){a.removeNPC(c.ID)})},a.prototype.addNPC=function(a,b,c,d,e){"undefined"==typeof e&&(e=1);var f={ID:a,Position:b,Target:b,GUID:"NPC-Animation-"+String(Math.random()*Math.random()*1e4),Direction:4,Speed:e,State:0,DisplaySpeechBubbleTo:void 0};this.npcList[a]=f,this.animation.addAnimation(f.GUID,c,d,b.X,b.Y)},a.prototype.getNPC=function(a){return this.npcList[a]},a.prototype.removeNPC=function(a){return void 0===this.npcList[a]?void this.gameHandler.error("No NPC with this ID found!",a):(this.animation.stopAnimation(this.npcList[a].GUID),void delete this.npcList[a])},a.prototype.setAnimation=function(a,b){return void 0===this.npcList[a]?void this.gameHandler.error("No NPC with this ID found!",a):void this.animation.playAnimation(this.npcList[a].GUID,b)},a.prototype.renderSpeechBubble=function(a,b,c){if("undefined"==typeof c&&(c=5),void 0===this.npcList[a])return void this.gameHandler.error("No NPC with this ID found!",a);var d=this.npcList[a],e="NPCSpeechBubble-"+a,f=this.animation,g=5*b.length+15,h=11,i=5,j=d.Position,k=0;g>this.gameHandler.config.tileSize&&(k=(g-this.gameHandler.config.tileSize)/2);var l={X:(j.X-1)*this.gameHandler.config.tileSize-k,Y:(j.Y-1.8)*this.gameHandler.config.tileSize};d.DisplaySpeechBubbleTo=Date.now()+1e3*c,f.drawColorRect(e,l.X,l.Y,g,h,255,255,255,.3,!1),f.writeText(e+"-text",b,l.X+g/2,l.Y,"11px sans-serif","top","center","rgba(0,0,0,1)",g-2*i,!1)},a.prototype.removeSpeechBubble=function(a){var b="NPCSpeechBubble-"+a,c=this.animation;c.removeGenericDraw(b),c.removeGenericDraw(b+"-text")},a.prototype.setPosition=function(a,b,c){return"undefined"==typeof c&&(c=!0),void 0===this.npcList[a]?void this.gameHandler.error("No NPC with this ID found!",a):(this.npcList[a].Position=b,void this.animation.setPosition(this.npcList[a].GUID,b.X,b.Y,c))},a.prototype.NPCMotionStop=function(a){return void 0===this.npcList[a]?void this.gameHandler.error("No NPC with this ID found!",a):void(this.npcList[a].State=0)},a.prototype.advInitMove=function(a,b,c,d,e,f){"undefined"==typeof f&&(f=!1);var g=this.npcList[a];return 1!==g.State||f?(this.setPosition(a,b),g.Speed=d,void this.initMove(a,c,e,f)):void this.gameHandler.log("NPC is already walking",g)},a.prototype.initMove=function(a,b,c,d){if("undefined"==typeof d&&(d=!1),void 0===this.npcList[a])return void this.gameHandler.error("No NPC with this ID found!",a);var e=this.npcList[a];if(1===e.State&&!d)return void this.gameHandler.log("NPC is already walking",e);var f={X:0,Y:0},g="stand",h="stand";switch(b){case 3:f.X=1,g="walk-right",h="stand-right";break;case 2:f.X=-1,g="walk-left",h="stand-left";break;case 0:f.Y=-1,g="walk-up",h="stand-up";break;case 1:f.Y=1,g="walk-down",h="stand"}this.animation.playAnimation(e.GUID,h);var i=CoordinateHelper.Add(e.Position,f);if(this.gameHandler.isCoordPassable(i.X,i.Y)){var j=1/e.Speed/this.updatesPerSecond,k=1/this.updatesPerSecond*1e3;e.Target=i,e.Direction=b,e.State=1,this.animation.playAnimation(e.GUID,g);var l=this;this.positionUpdateStep(e,b,j,k,function(){l.moveFinishedCallback(e),void 0!==c&&c()})}else this.gameHandler.log("Target not passable: ",i),e.State=0},a.prototype.moveFinishedCallback=function(a){var b="stand";switch(a.Direction){case 3:b="stand-right";break;case 2:b="stand-left";break;case 0:b="stand-up";break;case 1:b="stand"}this.animation.playAnimation(a.GUID,b),a.State=0},a.prototype.positionUpdateStep=function(a,b,c,d,e){if(0!==a.State){var f={X:0,Y:0};switch(b){case 3:f.X=c;break;case 2:f.X=-1*c;break;case 0:f.Y=-1*c;break;case 1:f.Y=c}var g=CoordinateHelper.Add(a.Position,f),h={X:Math.round(g.X),Y:Math.round(g.Y)};if(3===b&&g.X>a.Target.X||2===b&&g.X<a.Target.X||0===b&&g.Y<a.Target.Y||1===b&&g.Y>a.Target.Y)this.setPosition(a.ID,h),void 0!==e&&e(a);else{this.setPosition(a.ID,g);var i=this;i.gameHandler.eventHandler.callEvent("TaskCreated",i,"NPC - PlayerPositonUpdateStep"),window.setTimeout(function(){i.positionUpdateStep(a,b,c,d,e),i.gameHandler.eventHandler.callEvent("TaskDisposed",i,"NPC - PlayerPositonUpdateStep")},d)}}},a}(),PlayerManager=function(){function a(a,b,c){"undefined"==typeof c&&(c="pichu"),this.position={X:0,Y:0},this.targetPosition={X:0,Y:0},this.playerSpeed=.5,this.updatesPerSecond=20,this.playerElementName="player",this.playerState=0,this.moveDirection=4,this.lastAction=Date.now(),this.displaySpeechBubbleTo=void 0,this.keys={up:38,left:37,right:39,down:40,action:13},this.keysDown={},this.gameHandler=a,this.playerAnimation=b;var d=this;this.gameHandler.eventHandler.addEventListener("postInit",function(a,b){d.init(function(){},c)}),this.gameHandler.eventHandler.addEventListener("CheckIsPassable",function(a,b){b.X===d.position.X&&b.Y===d.position.Y&&(b.result=!1)}),this.gameHandler.eventHandler.addEventListener("NPCSpeechBubbleCheck",function(){void 0!==d.displaySpeechBubbleTo&&d.displaySpeechBubbleTo<Date.now()&&(d.removeSpeechBubble(),d.displaySpeechBubbleTo=void 0)})}return a.prototype.initMove=function(a,b,c,d){if("undefined"==typeof b&&(b=!0),"undefined"==typeof d&&(d=!0),1===this.playerState&&b)return void this.gameHandler.log("Player is already walking");this.lastAction=Date.now();var e={X:0,Y:0},f="stand",g="stand";switch(a){case 3:e.X=1,f="walk-right",g="stand-right";break;case 2:e.X=-1,f="walk-left",g="stand-left";break;case 0:e.Y=-1,f="walk-up",g="stand-up";break;case 1:e.Y=1,f="walk-down",g="stand"}b&&this.playAnimation(g);var h={X:this.position.X+e.X,Y:this.position.Y+e.Y};if(this.moveDirection=a,this.gameHandler.isCoordPassable(h.X,h.Y)){this.gameHandler.eventHandler.callEvent("PlayerStartMoving",this,{Target:h,Direction:a,Speed:this.playerSpeed,Position:this.position});var i=1/this.playerSpeed/this.updatesPerSecond,j=1/this.updatesPerSecond*1e3;this.targetPosition=h,this.playerState=1,b&&this.playAnimation(f);var k=this;this.positionUpdateStep(this,a,i,j,function(){k.moveFinishedCallback(d),void 0!==c&&c()})}else this.playerState=0},a.prototype.moveFinishedCallback=function(a){"undefined"==typeof a&&(a=!0);var b="stand",c=!1;switch(this.moveDirection){case 3:b="stand-right",c=this.keyDown(this.keys.right);break;case 2:b="stand-left",c=this.keyDown(this.keys.left);break;case 0:b="stand-up",c=this.keyDown(this.keys.up);break;case 1:b="stand",c=this.keyDown(this.keys.down)}c?this.initMove(this.moveDirection,!1):(a===!0&&this.playAnimation(b),this.playerState=0,this.gameHandler.eventHandler.callEvent("PlayerStopMoving",this,null))},a.prototype.positionUpdateStep=function(a,b,c,d,e){var f={X:0,Y:0};switch(b){case 3:f.X=c;break;case 2:f.X=-1*c;break;case 0:f.Y=-1*c;break;case 1:f.Y=c}var g=CoordinateHelper.Add(a.position,f),h={X:Math.round(g.X),Y:Math.round(g.Y)};3===b&&g.X>a.targetPosition.X||2===b&&g.X<a.targetPosition.X||0===b&&g.Y<a.targetPosition.Y||1===b&&g.Y>a.targetPosition.Y?(a.position=h,a.playerAnimation.setPosition(a.playerElementName,h.X,h.Y),
a.gameHandler.eventHandler.callEvent("PlayerPositionChanged",this,h),void 0!==e&&e()):(a.position=g,a.playerAnimation.setPosition(a.playerElementName,g.X,g.Y),a.gameHandler.eventHandler.callEvent("PlayerPositionChanged",this,g),a.gameHandler.eventHandler.callEvent("TaskCreated",a,"Player - PositionUpdateStep"),window.setTimeout(function(){a.positionUpdateStep(a,b,c,d,e),a.gameHandler.eventHandler.callEvent("TaskDisposed",a,"Player - PositionUpdateStep")},d))},a.prototype.init=function(a,b){var c=this;"undefined"==typeof b&&(b="pichu");var d=this;this.position.X=6,this.position.Y=6,this.movePlayerToSpawn(),this.initPlayer(function(){$(document).keydown(function(a){d.keysDown[a.keyCode]=!0,d.gameHandler.eventHandler.callEvent("PlayerManagerInputCheck",d,null)}).keyup(function(a){d.keysDown[a.keyCode]=!1,d.lastAction=Date.now()}),c.gameHandler.eventHandler.addTimedTrigger("playerManagerInputCheck","PlayerManagerInputCheck",500,c,null),c.gameHandler.eventHandler.addEventListener("PlayerManagerInputCheck",function(a,b){if(0===d.playerState)if(d.keyDown(d.keys.up))d.initMove(0);else if(d.keyDown(d.keys.down))d.initMove(1);else if(d.keyDown(d.keys.left))d.initMove(2);else if(d.keyDown(d.keys.right))d.initMove(3);else if(d.keyDown(d.keys.action)){var c=Date.now();c-d.lastAction>300&&d.playerAction()}}),c.gameHandler.eventHandler.addTimedTrigger("playerLastActivityCheck","PlayerLastActivityCheck",6e4,c,null),c.gameHandler.eventHandler.addEventListener("PlayerLastActivityCheck",function(a,b){var c=Date.now(),e=c-d.lastAction;e>12e4&&d.playAnimation("sleep")}),a()},b)},a.prototype.movePlayerToSpawn=function(){var a=this.gameHandler.getTilesByFlagName("player");0!==a.length&&(this.position.X=a[0].XCoord,this.position.Y=a[0].YCoord)},a.prototype.resetPlayerModel=function(){var a=this.gameHandler.config.playerModel;this.playerAnimation.clear(),this.setPlayerModel(a,this.position),this.gameHandler.eventHandler.callEvent("PlayerPositionChanged",this,this.position)},a.prototype.getPosition=function(){return this.position},a.prototype.keyDown=function(a){var b=this.keysDown[a];return void 0!==b&&b},a.prototype.initPlayer=function(a,b){var c=this;"undefined"==typeof b&&(b="pichu"),this.gameHandler.loadAnimation("data/animations/pichu.json",function(){c.gameHandler.loadAnimation("data/animations/mew.json",function(){c.gameHandler.loadAnimation("data/animations/pikachu.json",function(){c.setPlayerModel(b,c.position),c.gameHandler.eventHandler.callEvent("PlayerPositionChanged",c,c.position),a()})})})},a.prototype.setPlayerModel=function(a,b){"undefined"==typeof b&&(b=this.position),this.playerAnimation.addAnimation(this.playerElementName,a,"stand",b.X,b.Y),this.gameHandler.config.playerModel=a},a.prototype.playerAction=function(){var a={X:this.position.X,Y:this.position.Y};switch(this.moveDirection){case 3:a.X+=1;break;case 2:a.X+=-1;break;case 0:a.Y+=-1;break;case 1:a.Y+=1}this.lastAction=Date.now(),this.gameHandler.eventHandler.callEvent("PlayerAction",this,a)},a.prototype.playAnimation=function(a){this.gameHandler.eventHandler.callEvent("playerAnimationChange",this,a),this.playerAnimation.playAnimation(this.playerElementName,a)},a.prototype.renderSpeechBubble=function(a,b){"undefined"==typeof b&&(b=5);var c="NPCSpeechBubble-"+this.playerElementName,d=this.playerAnimation,e=5*a.length+15,f=11,g=5,h=this.position,i=0;e>this.gameHandler.config.tileSize&&(i=(e-this.gameHandler.config.tileSize)/2);var j={X:(h.X-1)*this.gameHandler.config.tileSize-i,Y:(h.Y-1.8)*this.gameHandler.config.tileSize};this.displaySpeechBubbleTo=Date.now()+1e3*b,d.drawColorRect(c,j.X,j.Y,e,f,255,255,255,.3,!1),d.writeText(c+"-text",a,j.X+e/2,j.Y,"11px sans-serif","top","center","rgba(0,0,0,1)",e-2*g,!1)},a.prototype.removeSpeechBubble=function(){var a="NPCSpeechBubble-"+this.playerElementName,b=this.playerAnimation;b.removeGenericDraw(a),b.removeGenericDraw(a+"-text")},a}(),Profiler=function(){function a(a){this.taskList={},this.gameHandler=a;var b=this;this.gameHandler.eventHandler.addEventListener("TaskCreated",function(a,c){void 0===b.taskList[c]&&(b.taskList[c]=0),b.taskList[c]+=1}),this.gameHandler.eventHandler.addEventListener("TaskDisposed",function(a,c){void 0!==b.taskList[c]&&(b.taskList[c]-=1,b.taskList[c]<=0&&delete b.taskList[c])})}return a}(),Renderer=function(){function a(a,b){if(this.fps=0,this.now=Date.now(),this.lastUpdate=Date.now(),this.fpsFilter=5,this.minTimeBetweenFrames=20,this.lastCheck=null,this.layer={BottomStaticLayer:{canvas:null,ctx:null},BottomAnimationLayer:{canvas:null,ctx:null},MiddleStaticLayer:{canvas:null,ctx:null},MiddleAnimationLayer:{canvas:null,ctx:null},PlayerLayer:{canvas:null,ctx:null},TopStaticLayer:{canvas:null,ctx:null},TopAnimationLayer:{canvas:null,ctx:null}},this.width=0,this.height=0,this.staticWidth=0,this.staticHeight=0,this.staticRendered=!1,this.elements={},this.map=[],this.offset={X:0,Y:0},this.eventHandler=null,this.gameHandler=null,this.gameHandler=b,void 0===b)return void console.warn("Second Argument of Renderer is undefined.");if(this.eventHandler=b.eventHandler,void 0===this.eventHandler)return void console.warn("Third Argument of Renderer is undefined.");this.eventHandler.callEvent("renderPreInit",this,null),this.canvas=a,this.width=this.gameHandler.config.width,this.height=this.gameHandler.config.height,this.ctx=this.canvas.getContext("2d"),$(this.canvas).attr("width",this.width).attr("height",this.height);var c=this;this.eventHandler.addEventListener("forceRerender",function(){c.beginDrawing()}),this.eventHandler.addEventListener("postInit",function(){c.beginDrawing()}),this.eventHandler.callEvent("renderPostInit",this,null)}return a.prototype.beginDrawing=function(){var a=Date.now()-this.lastCheck;if(!(null!=this.lastCheck&&a<this.minTimeBetweenFrames)){this.gameHandler.config.verbose&&this.gameHandler.log("Begin Rendering - Last Frame: ",a),this.lastCheck=Date.now(),this.render();var b=1e3/((this.now=Date.now())-this.lastUpdate);this.now!==this.lastUpdate&&(this.fps+=(b-this.fps)/this.fpsFilter,this.lastUpdate=this.now)}},a.prototype.getFPS=function(){return this.fps},a.prototype.initLayer=function(){var a=this;$.each(this.layer,function(b,c){("undefined"==typeof a.layer[b].canvas||null==a.layer[b].canvas)&&(a.layer[b].canvas=document.createElement("canvas")),$(a.layer[b].canvas).attr("width",a.staticWidth).attr("height",a.staticHeight),a.layer[b].ctx=a.layer[b].canvas.getContext("2d")}),("undefined"==typeof this.bufferCanvas||null==this.bufferCanvas)&&(this.bufferCanvas=document.createElement("canvas")),$(this.bufferCanvas).attr("width",this.staticWidth).attr("height",this.staticHeight),this.bufferCtx=this.bufferCanvas.getContext("2d")},a.prototype.setConfig=function(a){this.elements=a},a.prototype.initMap=function(a,b){this.staticHeight=b*this.gameHandler.config.tileSize,this.staticWidth=a*this.gameHandler.config.tileSize,this.initLayer()},a.prototype.setMap=function(a,b){return this.eventHandler.callEvent("renderPreMapLoad",this,null),b===!0&&(this.staticRendered=!1),0===this.staticHeight||0===this.staticWidth?void this.gameHandler.error("The function 'initMap' has to be called before the SetMap function!"):(this.map=a,b===!0&&this.eventHandler.callEvent("forceRerender",this,null),this.gameHandler.log("Renderer Map Loaded: ",this.map),void this.eventHandler.callEvent("renderPostMapLoad",this,null))},a.prototype.updateTile=function(a){return void 0!==a.BottomElementID&&null!==a.BottomElementID&&""!==a.BottomElementID&&(void 0!==this.elements[a.BottomElementID]?a.BottomElement=this.elements[a.BottomElementID]:this.gameHandler.warn("Warning: No Element definintion '"+a.BottomElementID+"' for Tile: ",a)),void 0!==a.MiddleElementID&&null!==a.MiddleElementID&&""!==a.MiddleElementID&&(void 0!==this.elements[a.MiddleElementID]?a.MiddleElement=this.elements[a.MiddleElementID]:this.gameHandler.warn("Warning: No Element definintion '"+a.MiddleElementID+"' for Tile: ",a)),void 0!==a.TopElementID&&null!==a.TopElementID&&""!==a.TopElementID&&(void 0!==this.elements[a.TopElementID]?a.TopElement=this.elements[a.TopElementID]:this.gameHandler.warn("Warning: No Element definintion '"+a.TopElementID+"' for Tile: ",a)),a},a.prototype.renderMap=function(a){function b(){c.eventHandler.callEvent("TaskCreated",this,"Renderer - RenderMapCallback - Step2"),window.setTimeout(function(){a(),c.eventHandler.callEvent("TaskDisposed",this,"Renderer - RenderMapCallback - Step2")},1),c.staticRendered=!0,c.eventHandler.callEvent("TaskDisposed",this,"Renderer - RenderMapCallback - Step1")}var c=this;this.eventHandler.callEvent("renderPreMapRender",this,null),this.gameHandler.config.verbose&&this.gameHandler.log("Map rendering ..."),this.clear(this.layer.BottomStaticLayer.ctx),this.clear(this.layer.MiddleStaticLayer.ctx),this.clear(this.layer.TopStaticLayer.ctx);for(var d=0;d<this.map.length;d++)for(var e=d*this.gameHandler.config.tileSize,f=0;f<this.map[d].length;f++){var g=f*this.gameHandler.config.tileSize;this.map[d][f].X=g,this.map[d][f].Y=e;var h=d===this.map.length-1&&f===this.map[d].length-1;h&&(this.eventHandler.callEvent("TaskCreated",this,"Renderer - RenderMapCallback - Step1"),window.setTimeout(b,100)),this.addTile(this.map[d][f],g,e,h?b:void 0)}this.eventHandler.callEvent("renderPostMapRender",this,null)},a.prototype.renderDynamic=function(){this.eventHandler.callEvent("render",this,this.layer)},a.prototype.render=function(){var b=this;this.eventHandler.callEvent("renderPreRender",this,null);var c=function(){b.clear(b.bufferCtx),b.bufferCtx.drawImage(b.layer.BottomStaticLayer.canvas,0,0),b.bufferCtx.drawImage(b.layer.BottomAnimationLayer.canvas,0,0),b.bufferCtx.drawImage(b.layer.MiddleStaticLayer.canvas,0,0),b.bufferCtx.drawImage(b.layer.MiddleAnimationLayer.canvas,0,0),b.bufferCtx.drawImage(b.layer.PlayerLayer.canvas,0,0),b.bufferCtx.drawImage(b.layer.TopStaticLayer.canvas,0,0),b.bufferCtx.drawImage(b.layer.TopAnimationLayer.canvas,0,0),b.ctx.drawImage(b.bufferCanvas,-1*b.offset.X,-1*b.offset.Y),a.SHOW_FPS&&b.ctx.fillText(b.fps.toFixed(2).toString(),5,10)};this.renderDynamic(),this.staticRendered?c():this.renderMap(c),this.eventHandler.callEvent("renderPostRender",this,null)},a.prototype.setOffset=function(a){this.offset.X=a.X,this.offset.Y=a.Y},a.prototype.getBottomAnimationLayer=function(){return this.layer.BottomAnimationLayer},a.prototype.getMiddleAnimationLayer=function(){return this.layer.MiddleAnimationLayer},a.prototype.getTopAnimationLayer=function(){return this.layer.TopAnimationLayer},a.prototype.getPlayerLayer=function(){return this.layer.PlayerLayer},a.prototype.getTileSize=function(){return this.gameHandler.config.tileSize},a.prototype.getMapSize=function(){return{X:this.staticWidth,Y:this.staticHeight}},a.prototype.clear=function(a){void 0!==a&&a.clearRect(0,0,this.staticWidth,this.staticHeight)},a.prototype.clearRenderContext=function(a){this.clear(a)},a.prototype.addTile=function(a,b,c,d){var e=a.BottomElement,f=a.MiddleElement,g=a.TopElement,h=function(a){return void 0===e&&void 0===f&&void 0===g?d:void 0!==e&&void 0===f&&void 0===g&&"bottom"===a?d:void 0!==e&&void 0!==f&&void 0===g&&"middle"===a?d:void 0!==e&&void 0!==g&&"top"===a?d:void 0};void 0===e||void 0!==e.Dynamic&&e.Dynamic||this.addImage(this.layer.BottomStaticLayer.ctx,e,b,c,void 0,void 0,h("bottom")),void 0===f||void 0!==f.Dynamic&&f.Dynamic||this.addImage(this.layer.MiddleStaticLayer.ctx,f,b,c,void 0,void 0,h("middle")),void 0===g||void 0!==g.Dynamic&&g.Dynamic||this.addImage(this.layer.TopStaticLayer.ctx,g,b,c,void 0,void 0,h("top"))},a.prototype.addImage=function(a,b,c,d,e,f,g){var h=this.gameHandler.config.basePath+b.ImageURI;if(void 0!==b.Dynamic&&b.Dynamic||void 0!==b.Flags&&-1!==b.Flags.indexOf("editorElement"))return void(void 0!==g&&g({x:c,y:d,width:e,height:f,image:i}));var i=new Image;"undefined"==typeof e&&(e=this.gameHandler.config.tileSize),"undefined"==typeof f&&(f=this.gameHandler.config.tileSize),i.onload=function(){a.drawImage(i,c,d,e,f),void 0!==g&&g({x:c,y:d,width:e,height:f,image:i})},i.src=h},a.prototype.getFile=function(a,b,c){return this.gameHandler.getFile(a,b,c)},a.SHOW_FPS=!1,a}(),ElementTypes;!function(a){a[a.Unknown=0]="Unknown",a[a.OnEvent=1]="OnEvent",a[a.SetVariable=2]="SetVariable",a[a.If=3]="If",a[a.Command=4]="Command",a[a.Event=5]="Event",a[a.Sound=6]="Sound",a[a.Variable=7]="Variable",a[a.Increment=8]="Increment",a[a.Decrement=9]="Decrement",a[a.Add=10]="Add",a[a.Sub=11]="Sub",a[a.Mult=12]="Mult",a[a.Div=13]="Div",a[a.Gt=14]="Gt",a[a.Lt=15]="Lt",a[a.Eq=16]="Eq",a[a.Neq=17]="Neq",a[a.GtE=18]="GtE",a[a.LtE=19]="LtE",a[a.And=20]="And",a[a.Nand=21]="Nand",a[a.Or=22]="Or",a[a.Nor=23]="Nor",a[a.Not=24]="Not",a[a.Tile=25]="Tile"}(ElementTypes||(ElementTypes={}));var ScriptHandler=function(){function a(a){this.typeShortcuts={">":14,"<":15,"==":16,"!=":17,">=":18,"<=":19,"&":20,"&&":20,"|":22,"||":22,"!":24,"+":10,"-":11,"*":12,"/":13},this.eventHandler={},this.variables={},this.gameHandler=a;var b=this;this.gameHandler.eventHandler.addEventListener("CommandTrigger",function(a,c){b.commandCalled(c)})}return a.prototype.loadScript=function(a,b){var c=this;this.gameHandler.getFile(a,function(d){null!=d?c.parseScript(d):c.gameHandler.warn("Script file is not valid!",a),b()})},a.prototype.parseScript=function(a){if(void 0===a||null==a)return void this.gameHandler.warn("Not enough arguments for function 'parseScript'");if(void 0===a.length)this.parseScriptNode(a);else for(var b=0;b<a.length;b++)this.parseScriptNode(a[b])},a.prototype.parseScriptNode=function(a){try{if(void 0===a.Type)return void this.gameHandler.warn("Can't parse object as Script, no Type attribute found!",a);var b=void 0!==this.typeShortcuts[a.Type]?this.typeShortcuts[a.Type]:ElementTypes[a.Type];if(void 0===b||null==b)return void this.gameHandler.warn("Can't parse object as Script, unknown Type",a);var c=null,d=null,e=null;switch(b){case 1:this.handleOnEvent(a);break;case 2:this.handleSetVariable(a);break;case 3:this.handleIf(a);break;case 4:this.checkParam(a,"Name")&&this.gameHandler.eventHandler.callEvent("CommandTrigger",this,a);break;case 5:this.checkParam(a,"Name")&&this.checkParam(a,"Arguments")&&this.gameHandler.eventHandler.callEvent(a.Name,this,a.Arguments);break;case 8:this.checkParam(a,"Name")&&(void 0!==this.variables[a.Name]?this.variables[a.Name]=Number(this.variables[a.Name])+1:this.gameHandler.warn("Unknown Varibale Name: ",a.Name));break;case 9:this.checkParam(a,"Name")&&(void 0!==this.variables[a.Name]?this.variables[a.Name]=Number(this.variables[a.Name])-1:this.gameHandler.warn("Unknown Varibale Name: ",a.Name));break;case 10:if(this.checkParam(a,"Values")&&this.checkParam(a,"Target")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Add Statement: ",a),!1;for(c=this.parseValue(a.Values),e=0,d=0;d<c.length;d++)e+=c[d];this.variables[a.Target]=e}break;case 11:if(this.checkParam(a,"Values")&&this.checkParam(a,"Target")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Sub Statement: ",a),!1;for(c=this.parseValue(a.Values),e=c[0],d=1;d<c.length;d++)e-=c[d];this.variables[a.Target]=e}break;case 12:if(this.checkParam(a,"Values")&&this.checkParam(a,"Target")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Mult Statement: ",a),!1;for(c=this.parseValue(a.Values),e=1,d=0;d<c.length;d++)e*=c[d];this.variables[a.Target]=e}break;case 13:if(this.checkParam(a,"Values")&&this.checkParam(a,"Target")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Div Statement: ",a),!1;for(c=this.parseValue(a.Values),e=c[0],d=1;d<c.length;d++)e/=c[d];this.variables[a.Target]=e}break;case 6:if(this.checkParam(a,"Path")){var f=new Audio(a.Path);f.play()}break;default:this.gameHandler.warn("Not supported Type in Script: ",b,a)}}catch(g){this.gameHandler.warn("Can't parse object as Script: ",g,a)}},a.prototype.handleOnEvent=function(a){if(this.checkParam(a,"Event")&&this.checkParam(a,"Actions")){if(void 0===this.eventHandler[a.Event]){this.eventHandler[a.Event]=[];var b={Actions:a.Actions,VariableName:void 0!==a.ArgumentName?a.ArgumentName:null},c=this;this.gameHandler.eventHandler.addEventListener(a.Event,function(b,d){for(var e=0;e<c.eventHandler[a.Event].length;e++){var f=c.eventHandler[a.Event][e].VariableName;void 0!==f&&null!=f&&(c.variables[f]=d),c.parseScript(c.eventHandler[a.Event][e].Actions)}})}this.eventHandler[a.Event].push(b)}},a.prototype.handleSetVariable=function(a){this.checkParam(a,"Name")&&this.checkParam(a,"Value")&&(this.variables[a.Name]=this.parseValue(a.Value))},a.prototype.commandCalled=function(a){var b=a.Name;switch(b){case"Log":this.checkParam(a,"Value")&&console.log(this.parseValue(a.Value))}},a.prototype.handleIf=function(a){if(this.checkParam(a,"Conditions")&&this.checkParam(a,"Then")){var b=this.parseValue(a.Conditions),c=!0,d=null;if(void 0===b.length)c=Boolean(b);else for(d=0;d<b.length;d++)c=c&&Boolean(b[d]);if(c)if(void 0!==a.Then.length)for(d=0;d<a.Then.length;d++)this.parseScript(a.Then);else this.parseScriptNode(a.Then);else if(void 0!==a.Else)if(void 0!==a.Else.length)for(d=0;d<a.Else.length;d++)this.parseScript(a.Else);else this.parseScriptNode(a.Else)}},a.prototype.parseValue=function(a){var b=null;if("object"!=typeof a)return a;if(void 0===a.Type){if(void 0!==a.length){var c=[];for(b=0;b<a.length;b++)c.push(this.parseValue(a[b]));return c}return this.gameHandler.warn("Can't parse as Value: ",a),null}try{var d=void 0!==this.typeShortcuts[a.Type]?this.typeShortcuts[a.Type]:ElementTypes[a.Type];if(void 0===d||null==d)return this.gameHandler.warn("Can't parse object as Value, unknown Type",a),null;var e=null,f=null;switch(d){case 7:return this.checkParam(a,"Name")?this.getVariable(a.Name):null;case 16:if(this.checkParam(a,"Values"))return void 0===a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Equals Statement: ",a),!1):2!==a.Values.length?(this.gameHandler.warn("Need exactly two Arguments for Equals Statement: ",a),!1):(e=this.parseValue(a.Values),e[0]===e[1]);break;case 17:if(this.checkParam(a,"Values"))return void 0===a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Not Equals Statement: ",a),!1):2!==a.Values.length?(this.gameHandler.warn("Need exactly two Arguments for Not Equals Statement: ",a),!1):(e=this.parseValue(a.Values),e[0]!==e[1]);break;case 14:if(this.checkParam(a,"Values"))return void 0===a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Greater Than Statement: ",a),!1):2!==a.Values.length?(this.gameHandler.warn("Need exactly two Arguments for Greater Than Statement: ",a),!1):(e=this.parseValue(a.Values),e[0]>e[1]);break;case 15:if(this.checkParam(a,"Values"))return void 0===a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Less Than Statement: ",a),!1):2!==a.Values.length?(this.gameHandler.warn("Need exactly two Arguments for Less Than Statement: ",a),!1):(e=this.parseValue(a.Values),e[0]<e[1]);break;case 18:if(this.checkParam(a,"Values"))return void 0===a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Greater Than Equals Statement: ",a),!1):2!==a.Values.length?(this.gameHandler.warn("Need exactly two Arguments for Greater Than Equals Statement: ",a),!1):(e=this.parseValue(a.Values),e[0]>=e[1]);break;case 19:if(this.checkParam(a,"Values"))return void 0===a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Less Than Equals Statement: ",a),!1):2!==a.Values.length?(this.gameHandler.warn("Need exactly two Arguments for Less Than Equals Statement: ",a),!1):(e=this.parseValue(a.Values),e[0]<=e[1]);break;case 24:if(this.checkParam(a,"Values"))return void 0!==a.Values.length?(this.gameHandler.warn("Not a valid Value Argument for Not Statement: ",a),!1):(a=this.parseValue(a.Values),!a);break;case 20:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for And Statement: ",a),!1;for(e=this.parseValue(a.Values),f=!0,b=0;b<e.length;b++)f=f&&e[b];return f}break;case 21:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Not And Statement: ",a),!1;for(e=this.parseValue(a.Values),f=!0,b=0;b<e.length;b++)f=f&&e[b];return!f}break;case 22:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Or Statement: ",a),!1;for(e=this.parseValue(a.Values),f=!1,b=0;b<e.length;b++)f=f||e[b];return f}break;case 23:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Not Or Statement: ",a),!1;for(e=this.parseValue(a.Values),f=!1,b=0;b<e.length;b++)f=f||e[b];return!f}break;case 10:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Add Statement: ",a),!1;for(void 0!==a.Target&&this.gameHandler.warn("The 'Target' Attribute is not valid when used as Parameter! This Parameter is going to be ignored.",a),e=this.parseValue(a.Values),f=0,b=0;b<e.length;b++)f+=e[b];return f}break;case 11:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Sub Statement: ",a),!1;for(void 0!==a.Target&&this.gameHandler.warn("The 'Target' Attribute is not valid when used as Parameter! This Parameter is going to be ignored.",a),e=this.parseValue(a.Values),f=e[0],b=1;b<e.length;b++)f-=e[b];return f}break;case 12:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Mult Statement: ",a),!1;for(void 0!==a.Target&&this.gameHandler.warn("The 'Target' Attribute is not valid when used as Parameter! This Parameter is going to be ignored.",a),e=this.parseValue(a.Values),f=1,b=0;b<e.length;b++)f*=e[b];return f}break;case 13:if(this.checkParam(a,"Values")){if(void 0===a.Values.length)return this.gameHandler.warn("Not a valid Value Argument for Div Statement: ",a),!1;for(void 0!==a.Target&&this.gameHandler.warn("The 'Target' Attribute is not valid when used as Parameter! This Parameter is going to be ignored.",a),e=this.parseValue(a.Values),f=e[0],b=1;b<e.length;b++)f/=e[b];return f}break;case 25:console.error("Not Implemented yet");break;default:return this.gameHandler.warn("Not supported Type for Value: ",d,a),null}}catch(g){this.gameHandler.warn("Error while parsing Value: ",a,g)}},a.prototype.getVariable=function(a){return void 0!==this.variables[a]?this.variables[a]:(this.gameHandler.warn("Variable not set!: ",a),null)},a.prototype.checkParam=function(a,b){return void 0===a[b]?(this.gameHandler.warn("Missing Argument '"+b+"' on '"+a.Type+"' Node! ",a),!1):!0},a}(),JavaScriptHandler=function(){function a(a){this.basePath="data/scripts/",this.mapPathReg=new RegExp("data/([^.]+).json"),this.gameHandler=a;var b=this;this.gameHandler.eventHandler.addEventListener("postMapLoad",function(a,c){var d=b.mapPathReg.exec(b.gameHandler.config.mapPath),e="map/"+d[1]+".js";b.gameHandler.log("Try to load ScriptFile: ",b.basePath+e),b.includeIfExist(e)})}return a.prototype.getScriptFile=function(a,b){return"undefined"==typeof b&&(b=!0),b&&(a=this.basePath+a),this.gameHandler.getFile(a,void 0,"text")},a.prototype.includeIfExist=function(a,b){"undefined"==typeof b&&(b=!0);var c=this;b&&(a=this.basePath+a),$.ajax({url:this.gameHandler.config.basePath+a,type:"HEAD",error:function(){c.gameHandler.log("File do not exist. Ignore. ",a)},success:function(){c.gameHandler.log("Map-Script found. Include.",a),c.include(a,!1)}})},a.prototype.include=function(a,b){"undefined"==typeof b&&(b=!0);var c=this.getScriptFile(a,b);this.run(c)},a.prototype.run=function(a){try{var b=new Function("gameHandler, loader",a);b(this.gameHandler,this)}catch(c){console.error("Error while executing Script file: ",c)}},a.prototype.playSound=function(a){var b=new Audio(a);b.play()},Object.defineProperty(a.prototype,"playerPosition",{get:function(){return this.gameHandler.playerManager.getPosition()},enumerable:!0,configurable:!0}),a}(),WindowManager=function(){function a(a){this.offsetDiff={X:0,Y:0},this.targetPos={X:0,Y:0},this.currentPos=null,this.gameHandler=a;var b=this;this.gameHandler.eventHandler.addEventListener("PlayerPositionChanged",function(a,c){b.onPlayerPositionUpdate(b,a,c)}),this.setSize(this.gameHandler.config.width,this.gameHandler.config.height),this.gameHandler.eventHandler.addTimedTrigger("windowManagerPositionUpdate","updateWindowPosition",10,this),this.gameHandler.eventHandler.addEventListener("updateWindowPosition",function(a,b){var c=a;c.updateWindowPosition()})}return a.prototype.onPlayerPositionUpdate=function(a,b,c){var d=this.gameHandler.config.tileSize,e=this.gameHandler.renderer.getMapSize(),f={X:e.X-this.gameHandler.config.width,Y:e.Y-this.gameHandler.config.height},g={X:c.X*d-this.offsetDiff.X,Y:c.Y*d-this.offsetDiff.Y};g={X:g.X<0?0:g.X>f.X?f.X:g.X,Y:g.Y<0?0:g.Y>f.Y?f.Y:g.Y},this.targetPos=g,null===this.currentPos&&(this.currentPos=g,this.gameHandler.renderer.setOffset(g))},a.prototype.updateWindowPosition=function(){if(null!==this.currentPos){var a=CoordinateHelper.Subtract(this.targetPos,this.currentPos),b=CoordinateHelper.Normalize(a);b=CoordinateHelper.Multiply(a,2),CoordinateHelper.Length(b)>CoordinateHelper.Length(a)&&(b=a),NaN!==b.X&&NaN!==b.Y?(this.currentPos=CoordinateHelper.Add(this.currentPos,b),this.gameHandler.config.verbose&&(this.gameHandler.log("Update Pos: Difference between Current and Target: ",a),this.gameHandler.log("Normalized Offset: ",b),this.gameHandler.log("New Target: ",this.currentPos)),this.gameHandler.renderer.setOffset(this.currentPos)):this.gameHandler.log("Normalized Vector is NaN!",{Target:this.targetPos,Current:this.currentPos,diff:a,offset:b})}},a.prototype.setSize=function(a,b){this.offsetDiff={X:a/2,Y:b/2}},a}(),PathHandler=function(){function a(a){this.debugElements=[],this.STOP=!1,this.gameHandler=a}return a.prototype.stopAllMovements=function(){this.STOP=!0;var a=this;window.setTimeout(function(){a.STOP=!1},1e3)},a.prototype.getRouteRaw=function(a,b){var c=this.gameHandler.getMapPassableData(),d=new Graph(c),e=d.grid[a.X-1][a.Y-1],f=d.grid[b.X-1][b.Y-1];return astar.search(d,e,f)},a.prototype.getRoute=function(a,b,c){"undefined"==typeof c&&(c=!1);for(var d=this.getRouteRaw(a,b),e=[],f=0;f<d.length;f++)e[f]={X:d[f].x+1,Y:d[f].y+1};return c===!0&&this.drawRoute(a,e),e},a.prototype.drawRoute=function(a,b){this.clearRoute();for(var c=0,d=a,e=0;e<b.length;e++){var f,g=this.gameHandler.config.tileSize,h=this.gameHandler.config.tileSize,i=b[e],j=CoordinateHelper.Subtract(d,i);0!==j.X?(g*=2,j.X<0?f=d:j.X>0&&(f=i)):0!==j.Y&&(h*=2,j.Y<0?f=d:j.Y>0&&(f=i));var k="pathHandlerDebugRect-"+c++,l=this.gameHandler.config.tileSize;this.gameHandler.topAnimationHandler.drawColorRect(k,(f.X-1)*l,(f.Y-1)*l,g,h,255,0,0,.3,!1),this.debugElements.push(k),d=i}},a.prototype.clearRoute=function(){for(var a=0;a<this.debugElements.length;a++)this.gameHandler.topAnimationHandler.removeGenericDraw(this.debugElements[a]);this.debugElements=[]},a.prototype.movePlayer=function(a,b,c){"undefined"==typeof b&&(b=!1),"undefined"==typeof c&&(c=void 0);var d=this,e=this.gameHandler.playerManager.getPosition(),f=this.getRoute(e,a,b),g=0,h=4,i=function(){if(!d.STOP){if(g+1>=f.length)return void("undefined"!=typeof c?c():console.log("Reached Destination"));var a=f[g],b=f[g+1],e=d.getDirectionFromOffset(a,b),j=e!==h;d.gameHandler.playerManager.initMove(e,j,i,!(g+2>=f.length)),h=e,g++}},j=this.getDirectionFromOffset(e,f[0]);h=j,this.gameHandler.playerManager.initMove(j,!0,i)},a.prototype.moveNPC=function(a,b,c,d){"undefined"==typeof c&&(c=!1),"undefined"==typeof d&&(d=void 0);var e=this,f=this.gameHandler.npcManager.getNPC(a),g=f.Position,h=this.getRoute(g,b,c),i=0,j=4,k=function(){if(!e.STOP){if(i+1>=h.length)return void("undefined"!=typeof d?d():console.log("Reached Destination"));var b=h[i],c=h[i+1],f=e.getDirectionFromOffset(b,c);e.gameHandler.npcManager.initMove(a,f,k),j=f,i++}},l=this.getDirectionFromOffset(g,h[0]);j=l,e.gameHandler.npcManager.initMove(a,l,k)},a.prototype.getDirectionFromOffset=function(a,b){var c=CoordinateHelper.Subtract(b,a);return c.X>0?3:c.X<0?2:c.Y>0?1:c.Y<0?0:4},a}();